<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="service-records-container">
  <!-- Combined Feature: AutoComplete Search -->
  <p-card header="Search Vehicle by VIN" styleClass="mb-4">
    <div class="search-box">
      <span class="p-input flex-1">
        <p-autoComplete
          [(ngModel)]="selectedVehicle"
          [suggestions]="filteredVehicles"
          (completeMethod)="searchVehicles($event)"
          (onSelect)="onVehicleSelect($event)"
          (onClear)="onClear()"
          field="label"
          [dropdown]="true"
          placeholder="Type VIN or vehicle details..."
          [showClear]="true"
          styleClass="w-full"
        >
        </p-autoComplete>
      </span>
    </div>

    <p-message
      *ngIf="searchError"
      severity="error"
      [text]="searchError"
      styleClass="mt-3"
    ></p-message>


    <div *ngIf="selectedVehicleData" class="mt-4">
      <p-card header="Vehicle Information" styleClass="mb-3">
        <div class="grid">
          <div class="col-12 md:col-6">
            <p><strong>VIN:</strong> {{ selectedVehicleData.vin }}</p>
            <p>
              <strong>Owner:</strong> {{ selectedVehicleData.first_name }}
              {{ selectedVehicleData.last_name }}
            </p>
          </div>
          <div class="col-12 md:col-6">
            <p>
              <strong>Vehicle:</strong> {{ selectedVehicleData.car_make }}
              {{ selectedVehicleData.car_model }}
            </p>
            <p>
              <strong>Age:</strong>
              {{ selectedVehicleData.age_of_vehicle }} years
            </p>
          </div>
        </div>
      </p-card>

      <p-card header="Service Records">
        <div class="flex justify-content-between align-items-center mb-3">
          <h4>Service History</h4>
          <p-button
            label="Add Service Record"
            icon="pi pi-plus"
            (onClick)="openCreateDialog()"
            styleClass="p-button-success"
            [style]="{ 'border-radius': '10px' }"
          ></p-button>
        </div>

        <div *ngIf="recordsLoading" class="text-center mt-4">
          <p-progressSpinner styleClass="w-4rem h-4rem"></p-progressSpinner>
          <p>Loading service records...</p>
        </div>

        <p-message
          *ngIf="vehicleRecords.length === 0 && !recordsLoading"
          severity="info"
          text="No service records found for this vehicle."
          styleClass="mb-3"
        ></p-message>

        <div *ngIf="vehicleRecords.length > 0 && !recordsLoading">
          <p-table [value]="vehicleRecords" styleClass="p-datatable-striped">
            <ng-template pTemplate="header">
              <tr>
                <th>Date</th>
                <th>Service Type</th>
                <th>Description</th>
                <th>Cost</th>
                <th>Mechanic</th>
                <th>Actions</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-record>
              <tr>
                <td>{{ formatDate(record.service_date) }}</td>
                <td>{{ record.service_type }}</td>
                <td>{{ record.description }}</td>
                <td>{{ formatCurrency(record.cost) }}</td>
                <td>{{ record.mechanic_name }}</td>
                <td>
                  <p-button
                    icon="pi pi-pencil"
                    styleClass="p-button-rounded p-button-text p-button-warning mr-2"
                    (onClick)="openEditDialog(record)"
                    pTooltip="Edit"
                  ></p-button>
                  <p-button
                    icon="pi pi-trash"
                    styleClass="p-button-rounded p-button-text p-button-danger"
                    (onClick)="deleteRecord(record)"
                    pTooltip="Delete"
                  ></p-button>
                </td>
              </tr>
            </ng-template>
          </p-table>
        </div>
      </p-card>
    </div>
  </p-card>
</div>

<p-dialog
  [(visible)]="displayDialog"
  [header]="isEditMode ? 'Edit Service Record' : 'Add Service Record'"
  [modal]="true"
  [style]="{ width: '600px' }"
  [draggable]="false"
  [resizable]="false"
>
  <form [formGroup]="recordForm">
    <div class="p-fluid">
      <div class="field">
        <label for="service_type">Service Type *</label>
        <input
          pInputText
          id="service_type"
          formControlName="service_type"
          placeholder="e.g., Oil Change, Brake Service"
        />
        <small
          class="p-error"
          *ngIf="
            recordForm.get('service_type')?.invalid &&
            recordForm.get('service_type')?.touched
          "
        >
          Service type is required
        </small>
      </div>

      <div class="field">
        <label for="description">Description *</label>
        <textarea
          pInputTextarea
          id="description"
          formControlName="description"
          rows="3"
          placeholder="Enter service details"
        ></textarea>
        <small
          class="p-error"
          *ngIf="
            recordForm.get('description')?.invalid &&
            recordForm.get('description')?.touched
          "
        >
          Description is required
        </small>
      </div>

      <div class="field">
        <label for="cost">Cost ($) *</label>
        <p-inputNumber
          inputId="cost"
          formControlName="cost"
          mode="decimal"
          [minFractionDigits]="2"
          [maxFractionDigits]="2"
          placeholder="0.00"
        ></p-inputNumber>
        <small
          class="p-error"
          *ngIf="
            recordForm.get('cost')?.invalid && recordForm.get('cost')?.touched
          "
        >
          Cost is required and must be positive
        </small>
      </div>

      <div class="field">
        <label for="service_date">Service Date *</label>
        <p-calendar
          inputId="service_date"
          formControlName="service_date"
          dateFormat="yy-mm-dd"
          [showIcon]="true"
          placeholder="Select date"
        ></p-calendar>
        <small
          class="p-error"
          *ngIf="
            recordForm.get('service_date')?.invalid &&
            recordForm.get('service_date')?.touched
          "
        >
          Service date is required
        </small>
      </div>

      <div class="field">
        <label for="mechanic_name">Mechanic Name *</label>
        <input
          pInputText
          id="mechanic_name"
          formControlName="mechanic_name"
          placeholder="Enter mechanic's name"
        />
        <small
          class="p-error"
          *ngIf="
            recordForm.get('mechanic_name')?.invalid &&
            recordForm.get('mechanic_name')?.touched
          "
        >
          Mechanic name is required
        </small>
      </div>
    </div>
  </form>

  <ng-template pTemplate="footer">
    <p-button
      label="Cancel"
      icon="pi pi-times"
      (onClick)="displayDialog = false"
      styleClass="p-button-text"
    ></p-button>
    <p-button
      [label]="isEditMode ? 'Update' : 'Create'"
      icon="pi pi-check"
      (onClick)="saveRecord()"
      [loading]="saving"
    ></p-button>
  </ng-template>
</p-dialog>
